{"ast":null,"code":"var pull = require('pull-stream');\n\nmodule.exports = pull.Source(function (onClose) {\n  var buffer = [],\n      cbs = [],\n      waiting = [],\n      ended;\n\n  function drain() {\n    var l;\n\n    while (waiting.length && ((l = buffer.length) || ended)) {\n      var data = buffer.shift();\n      var cb = cbs.shift();\n      waiting.shift()(l ? null : ended, data);\n      cb && cb(ended === true ? null : ended);\n    }\n  }\n\n  function read(end, cb) {\n    ended = ended || end;\n    waiting.push(cb);\n    drain();\n    if (ended) onClose && onClose(ended === true ? null : ended);\n  }\n\n  read.push = function (data, cb) {\n    if (ended) return cb && cb(ended === true ? null : ended);\n    buffer.push(data);\n    cbs.push(cb);\n    drain();\n  };\n\n  read.end = function (end, cb) {\n    if ('function' === typeof end) cb = end, end = true;\n    ended = ended || end || true;\n    if (cb) cbs.push(cb);\n    drain();\n    if (ended) onClose && onClose(ended === true ? null : ended);\n  };\n\n  return read;\n});","map":null,"metadata":{},"sourceType":"script"}